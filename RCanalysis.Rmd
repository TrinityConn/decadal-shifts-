---
title: "Untitled"
author: "Ross Cunning"
date: "2025-08-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries}
library(janitor)
library(phyloseq)  # BiocManager::install("phyloseq")
library(cowplot)
library(ggrepel)
library(scales)
library(RColorBrewer)
library(MASS)
library(lme4)
library(emmeans)
library(tidyverse)
library(vegan)
library(ggh4x)
library(stringi)
```

```{r ggplot_theme}
# Create custom ggplot theme
theme_custom <- function() {
  theme_bw(base_size = 10, base_family = "Arial") %+replace%
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      panel.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.background = element_rect(fill = NA, colour = NA)
    )
}

sppord <- factor(levels = c("Cnat", "Dlab", "Pstr", "Pfur",
                            "Ssid", "Oann", "Ofav", "Ofra", "Mcav"))

## ggplot labeller
sppnames <- c(
  Cnat = "C. natans",
  Dlab = "D. labyrinthiformis",
  Pstr = "P. strigosa",
  Pfur = "P. furcata",
  Ssid = "S. siderea",
  Oann = "O. annularis",
  Ofav = "O. faveolata",
  Ofra = "O. franksi",
  Mcav = "M. cavernosa"
)

sitenames <- c(
  EastTektite = "ET",
  WhitePoint = "WP",
  CabritteHorn = "CH"
)

global_labeller <- labeller(
  gspp = sppnames,
  host_site = sitenames
)
```

# Load coral sample metadata
```{r}
# Load keys site metadata
keysmd <- read_csv("keysdata/keys_symbiont_metadata.csv", col_types = "c") %>%
  mutate(across(everything(), as.character)) %>%
  clean_names()


# Load full metadata
md <- readxl::read_xls("metadata/decadalshifts_SST.xls")

md
```

# Load data from Pawar run
## profiles
```{r load_its2_profiles_pawar_run}
sam0 <- read_tsv("data/20240723T194127_Pawar_Run /post_med_seqs/500_20240730T092802_DBV_20240730T195050.seqs.absolute.abund_and_meta.txt") %>%
  clean_names() %>%
  select(sample_uid, sample_name, fastq_fwd_file_name, fastq_rev_file_name, data_set_uid, data_set_name,
         host_genus, host_species, collection_latitude, collection_longitude, collection_date, collection_depth) %>%
  slice(1:(n() - 1)) # Remove last row - not a sample
sam1 <- as.matrix(sam0)
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))
rownames(sam)

tax0 <- read_tsv(
  file = "data/20240723T194127_Pawar_Run /its2_type_profiles/500_20240730T092802_DBV_20240730T195050.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()
tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "data/20240723T194127_Pawar_Run /its2_type_profiles/500_20240730T092802_DBV_20240730T195050.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = "...2") %>%
  select(-1) %>%
  slice(7:(n() - 2)) %>%   # remove non-sample rows
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

profiles_pawar <- phyloseq(otu, tax, sam)
taxa_names(profiles_pawar) <- data.frame(tax_table(profiles_pawar))$its2_type_profile
```

## variants
```{r load_its2_variants_pawar_run}
taxnames <- read_tsv(
  file = "data/20240723T194127_Pawar_Run /post_med_seqs/500_20240730T092802_DBV_20240730T195050.seqs.absolute.abund_and_meta.txt",
  n_max = 0) %>%
  select(-(1:39)) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "data/20240723T194127_Pawar_Run /post_med_seqs/500_20240730T092802_DBV_20240730T195050.seqs.absolute.abund_and_meta.txt") %>% 
  select(-1, -(3:39))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

variants_pawar <- phyloseq(otu, tax, sam)
```

# Load data from Conn runs
## profiles
```{r load_its2_profiles_conn_run}
sam0 <- read_tsv("data/20250702T202717_Conn_Run/post_med_seqs/606_20250710T083602_DBV_20250712T034645.seqs.absolute.abund_and_meta.txt") %>%
  clean_names() %>%
  select(sample_uid, sample_name, fastq_fwd_file_name, fastq_rev_file_name, data_set_uid, data_set_name,
         host_genus, host_species, collection_latitude, collection_longitude, collection_date, collection_depth) %>%
  slice(1:(n() - 1)) # Remove last row - not a sample
sam1 <- as.matrix(sam0)
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))
rownames(sam)

tax0 <- read_tsv(
  file = "data/20250702T202717_Conn_Run/its2_type_profiles/606_20250710T083602_DBV_20250712T034645.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()
tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "data/20250702T202717_Conn_Run/its2_type_profiles/606_20250710T083602_DBV_20250712T034645.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = "...2") %>%
  select(-1) %>%
  slice(7:(n() - 2)) %>%   # remove non-sample rows
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

profiles_conn <- phyloseq(otu, tax, sam)
taxa_names(profiles_conn) <- data.frame(tax_table(profiles_conn))$its2_type_profile
```

## variants
```{r load_its2_variants_conn_run}
taxnames <- read_tsv(
  file = "data/20250702T202717_Conn_Run/post_med_seqs/606_20250710T083602_DBV_20250712T034645.seqs.absolute.abund_and_meta.txt",
  n_max = 0) %>%
  select(-(1:39)) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "data/20250702T202717_Conn_Run/post_med_seqs/606_20250710T083602_DBV_20250712T034645.seqs.absolute.abund_and_meta.txt") %>% 
  select(-1, -(3:39))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

variants_conn <- phyloseq(otu, tax, sam)
```

# Filter to just Florida Keys samples, and merge data
```{r its2_filter}
mastermd <- readxl::read_xlsx("metadata/Symbiont_DecadalShifts_Master.xlsx") %>%
  clean_names()

fl <- mastermd %>%
  filter(region == "Florida")

profiles_conn_fl <- subset_samples(profiles_conn, sample_name %in% fl$tube_label)
variants_conn_fl <- subset_samples(variants_conn, sample_name %in% fl$tube_label)

profiles_merged <- merge_phyloseq(profiles_pawar, profiles_conn_fl)
profiles_merged
ntaxa(profiles_pawar)
ntaxa(profiles_conn_fl)
ntaxa(profiles_merged)

variants_merged <- merge_phyloseq(variants_pawar, variants_conn_fl)
ntaxa(variants_pawar)
ntaxa(variants_conn)
ntaxa(variants_merged)
```

# Coral sampling summary
```{r sampling_summary_table1}
# Create table of number of tagged colonies sampled at each site at each year
table1 <- as_tibble(sample_data(profiles_merged)) %>%
  left_join(keysmd, by = "sample_name") %>%
  drop_na(collection_site) %>%
  mutate(year = str_sub(collection_date.x, 1, 4),
         era = case_when(year < 2005 ~ "historical",
                         year >= 2023 ~ "post-2023",
                         TRUE ~ "contemporary")) %>%
  group_by(era, host_species, collection_site) %>%
  summarize(n = n()) %>%
  arrange(collection_site, era) %>%
  pivot_wider(names_from = c(collection_site, era), values_from = n) %>% 
  adorn_totals(where = "row")
table1


```

# ITS2 sequence dataset summary and QC
```{r its2_qc}
# Total number of post-MED sequences in dataset
sum(sample_sums(variants))
# Total number of samples in dataset
nsamples(variants)

# Filter out samples with low read counts
low <- sample_sums(variants) < 1000
table(low)  # Number of samples being filtered out due to low read counts
variants <- subset_samples(variants, !low)
variants <- prune_taxa(taxa_sums(variants) != 0, variants)
profiles <- subset_samples(profiles, !low)
profiles <- prune_taxa(taxa_sums(profiles) != 0, profiles)

# Read count analysis
hist(sample_sums(variants), breaks = 100)
# One sample is an outlier with very high read count -- remove for summary stats of remaining samples
outlier <- sample_sums(variants)[which(sample_sums(variants) == max(sample_sums(variants)))]
woout <- sample_sums(variants)[which(sample_sums(variants) != max(sample_sums(variants)))]

# Histogram of remaining samples read counts
hist(woout, breaks = 50)

# Mean number of sequences per sample and standard deviation
mean(woout); sd(woout)

# Count number of sequences and profiles by genus(/clade)
# Sequences
data.frame(tax_table(variants)) %>% as_tibble() %>%
  count(clade) %>%
  adorn_totals(where = "row")
# Profiles
data.frame(tax_table(profiles)) %>% as_tibble() %>%
  count(clade) %>%
  adorn_totals(where = "row")
```

# Analyze ITS2 sequence composition across all samples

### Barplots of sequence variant and profile composition
```{r its2_barplots, fig.width = 10, fig.height = 5}
## Transform to relative abundance
v <- transform_sample_counts(variants, function(x) x/sum(x))     # Relative abundance
p <- transform_sample_counts(profiles, function(x) x/sum(x))     # Relative abundance

## Filter out variants less than 0.1% relative abundance for plotting
vt <- transform_sample_counts(v, function(x) ifelse(x > 0.001, x, 0))
vt <- prune_taxa(taxa_sums(vt) != 0, vt)

## Order colonies by sequence variant composition similarity within species for plotting
mp <- merge_samples(vt, "host_id")
hc <- hclust(dist(data.frame(otu_table(mp))))
neword <- tibble(host_id = as.character(sample_data(mp)$host_id), ord = hc$order)

## Set colors for plotting sequence variants, with distinct palettes for each symbiont clade/genus
tt <- as_tibble(data.frame(tax_table(vt))) %>%
  arrange(clade, DIV)
nt <- tt %>% count(clade) %>% pivot_wider(names_from = clade, values_from = n)
acols <- colorRampPalette(brewer.pal(9, "Greys"))(nt$A)
bcols <- colorRampPalette(brewer.pal(9, "Greens"))(nt$B)
ccols <- colorRampPalette(brewer.pal(9, "Blues"))(nt$C)
dcols <- colorRampPalette(brewer.pal(4, "Oranges"))(nt$D)
set.seed(556)
vpal <- c(acols[shuffle(acols)], bcols[shuffle(bcols)], ccols[shuffle(ccols)], dcols[shuffle(dcols)])
vpal <- setNames(vpal, tt$DIV)

## Set plotting order for sequence variants
divord <- as_tibble(data.frame(tax_table(vt))) %>%
  arrange(clade, DIV) %>%
  mutate(DIV = as_factor(DIV))

vmdf <- psmelt(vt) %>%
  left_join(neword) %>%
  arrange(host_genus, host_species, host_site, ord, year, clade, DIV) %>%
  mutate(host_id = as_factor(host_id),
         sample_id = as_factor(paste(host_genus, host_species, host_id, year, sep = "_")),
         genus_species = as_factor(paste(str_sub(host_genus, 1, 1), ". ", host_species, sep = "")),
         gspp = factor(paste0(str_sub(host_genus, 1, 1), str_sub(host_species, 1, 3)),
                       levels = levels(sppord)),
         DIV = factor(DIV, levels = divord$DIV))

# Create barplot for sequence variants
g1 <- ggplot(vmdf, aes(x = year, y = Abundance)) + 
  geom_col(width = 1, aes(fill = DIV)) + 
  facet_nested(~ gspp + host_site + host_id, 
               labeller = global_labeller,
               space = "free_x",
               nest_line = element_line(linetype = 1),
               remove_labels = "x") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent) +
  ylab("ITS2 sequences") +
  scale_fill_manual(values = vpal[vmdf$OTU]) +
  theme(legend.position = "none", panel.background = element_blank(),
        text = element_text(size = 6), plot.margin = margin(5.5, 5.5, 1, 5.5),
        strip.text.x = element_text(margin = margin(0.5, 0, 0.5, 0, "mm"), face = "italic"),
        axis.title.x = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.spacing = unit(0.25, "mm"),
        strip.background = element_blank())

# Repeat for profiles
### truncate its2_type_profile names
pp <- as_tibble(data.frame(tax_table(p))) %>%
  arrange(clade, its2_type_profile) %>%
  mutate(its2_type_profile_trunc = str_trunc(its2_type_profile, 22, "right"))
np <- pp %>% count(clade) %>% pivot_wider(names_from = clade, values_from = n)
acols <- brewer.pal(np$A, "Greys")
bcols <- colorRampPalette(brewer.pal(9, "YlGn"))(np$B)
ccols <- colorRampPalette(brewer.pal(6, "PuBu"))(np$C)
dcols <- brewer.pal(np$D, "Reds")
set.seed(556)
ppal <- c(acols, bcols, ccols, dcols)
ppal <- setNames(ppal, pp$its2_type_profile_trunc)

proford <- as_tibble(data.frame(tax_table(p))) %>%
  mutate(its2_type_profile_trunc = str_trunc(its2_type_profile, 22, "right")) %>%
  arrange(clade, its2_type_profile_trunc) %>%
  mutate(its2_type_profile = as_factor(its2_type_profile_trunc))
  
pmdf <- psmelt(p) %>%
  left_join(neword) %>%
  arrange(host_genus, host_species, host_site, ord, year, clade, its2_type_profile) %>%
  mutate(host_id = as_factor(host_id),
         its2_type_profile_trunc = str_trunc(its2_type_profile, 22, "right"),
         sample_id = as_factor(paste(host_genus, host_species, host_id, year, sep = "_")),
         genus_species = as_factor(paste(str_sub(host_genus, 1, 1), ". ", host_species, sep = "")),
         gspp = factor(paste0(str_sub(host_genus, 1, 1), str_sub(host_species, 1, 3)),
                       levels = levels(sppord))) %>%
  filter(Abundance > 0.01)

# Create barplot for profiles
g2 <- ggplot(pmdf, aes(x = year, y = Abundance)) +
    geom_col(width = 1, aes(fill = its2_type_profile_trunc)) +
    facet_nested(~ gspp + host_site + host_id) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    ylab("Profiles") +
    scale_fill_manual(values = ppal[pmdf$its2_type_profile_trunc], limits = force, drop = TRUE) +
    theme(legend.position = "bottom", legend.key.size = unit(3, "mm"), legend.title = element_blank(),
          legend.margin = margin(1, 0, 0, 0), legend.box.margin = margin(-10, -10, 0, -10),
          legend.key = element_rect(fill = NA),
          plot.margin = margin(0, 5.5, 5.5, 5.5),
          text = element_text(size = 6), legend.text = element_text(size = 4),
          panel.background = element_blank(), strip.text.x = element_blank(),
          axis.title.x = element_blank(), axis.text.y = element_blank(), 
          axis.text.x = element_text(angle = 90, vjust = 0.5, size = 3),
          axis.ticks.x = element_line(size = 0.25),
          axis.ticks.y = element_blank(),
          strip.background = element_blank(),
          panel.spacing = unit(0.25, "mm")) +
    guides(fill = guide_legend(ncol = 3))

# Extract legend from profiles barplot to use in multipanel figure below
g2leg <- get_legend(g2)
g2leg <- ggplotify::as.ggplot(g2leg) + theme(plot.margin = unit(c(-30, 0, 0, -10), "mm"))
g2 <- g2 + theme(legend.position = "none")

# Combine variants and profiles barplots into single panel to be Figure 1a
fig1a <- plot_grid(g1, g2, nrow = 2, label_fontface = "plain", rel_heights = c(0.6, 0.4))

# Display Figure 1a
fig1a
```

